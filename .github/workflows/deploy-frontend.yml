name: Deploy Frontend (Yandex Serverless Container)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

env:
  REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}
  IMAGE_NAME: book-club-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Yandex Container Registry
        run: echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' | docker login --username json_key --password-stdin cr.yandex

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          docker build \
            --build-arg VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }} \
            --build-arg VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }} \
            -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"

      - name: Deploy to Serverless Container
        run: |
          # Install Yandex Cloud CLI
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          # Authenticate with service account
          echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > sa-key.json
          yc config set service-account-key sa-key.json
          rm sa-key.json

          # Deploy new revision
          yc serverless container revision deploy \
            --container-id ${{ secrets.YC_CONTAINER_ID }} \
            --image "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --memory 128mb \
            --execution-timeout 10s \
            --concurrency 16 \
            --service-account-id ${{ secrets.YC_SA_ID }}
